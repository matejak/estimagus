{% from 'bootstrap5/utils.html' import render_icon %}
{% from 'bootstrap5/form.html' import render_form %}

{% macro render_whatever_retro(target, model, today, recursive=true) %}
{% if target.children %}
{{ render_epic_retro(target, model, today, recursive) }}
{% else %}
{{ render_task(target, model) }}
{% endif %}
{% endmacro %}

{% macro render_epic_retro(epic, model, today, recursive=true) %}
    <li>
        <div id="{{ epic.name }}">
        {{ epic_link(epic, "main.view_epic_retro") }} &mdash; {{ epic.title }}
        <div class="container-md">
           <div class="row">
              <div class="col">

        <p>
        {{ state_to_string(epic.state) }}, {{ "%.2g" % model.remaining_point_estimate_of(epic.name).expected }} points remaining.
        </p>
        <p>
	Owner:
        {%- if epic.assignee -%}
	{{ " " ~ epic.assignee }}
        {%- else -%}
	{{ " nobody" }}
        {%- endif %}
        </p>
        {% if epic.status_summary -%}
        <p>
	Summary
        {%- if epic.status_summary_time -%}
	{{ " " ~ (today - epic.status_summary_time).days }} days old
        {%- endif -%}
	: {{ epic.status_summary | safe }}</p>
        {%- endif %}
        {% if recursive -%}
        {% for target in (epic.children | sort(attribute="name")) %}
        <ul>
            {{- render_whatever_retro(target, model, today, recursive=recursive) -}}
        </ul>
        {% endfor %}
        {%- endif %}

              </div>
              {% if model.remaining_point_estimate_of(epic.name).expected > 0 %}
              <div class="col">
    <img src="{{ url_for('vis.visualize_epic_burndown', epic_name=epic.name, size="small") }}" alt="Epic Burndown"/>
              </div>
              {% endif %}
           </div>
        </div>
        </div>
    </li>
{% endmacro %}

{% macro render_whatever(target, model, recursive=true) %}
{% if target.children %}
{{ render_epic(target, model, recursive=recursive) }}
{% else %}
{{ render_task(target, model) }}
{% endif %}
{% endmacro %}

{% macro refresh_whatever(target, mode, next) -%}
        <a href="{{ url_for("main.refresh_single", name=target.name, mode=mode, next=next) }}">{{ render_icon("arrow-clockwise") }}</a>
{%- endmacro %}

{% macro task_link(task) -%}
        <a href="{{ url_for("main.view_task", task_name=task.name) }}">{{ task.name }}</a>&nbsp;<a href="{{ task.uri }}" rel="external">{{ render_icon("box-arrow-up-right") }}</a>
{%- endmacro %}

{% macro epic_external_link(epic) -%}
	<a href="{{ epic.uri }}" rel="external">{{ render_icon("box-arrow-up-right") }}</a>
{%- endmacro %}

{% macro epic_link(epic, endpoint="main.view_epic") -%}
        <a href="{{ url_for(endpoint, epic_name=epic.name) }}">{{ epic.name }}</a>&nbsp;{{ epic_external_link(epic) }}
{%- endmacro %}

{% macro render_state_short(state) -%}
        <span class="state.style_class">state.shortcut</span>
{%- endmacro %}

{% macro render_state(state) -%}
        <span class="state.style_class">state.name</span>
{%- endmacro %}

{% macro render_task_basic(task, model) -%}
        {{ task_link(task) }} &mdash; <span class="task-state">{{ state_to_string(task.state) }}</span><span class="task-points {{- " uncounted_points" if model and model.get_element(task.name).masked }}">{{ "%.2g" % task.point_cost }}</span>
	{{ truncate_text_to(task.title, "350pt") }}
{%- endmacro %}

{% macro truncate_text_to(text, width) -%}
<span class="d-inline-block text-truncate align-top" style="max-width: {{ width }};">{{ text }}</span>
{%- endmacro %}

{% macro render_task(task, model) %}
        <li>
        <div id={{ task.name }}">
        {{- render_task_basic(task, model) -}}
        </div>
        </li>
{% endmacro %}

{% macro render_epic_basic(epic) %}
        {{ epic_link(epic) }} &mdash; {{ epic.title }}
{% endmacro %}

{% macro render_epic(epic, model, recursive=true) %}
        <li>
        <div id={{ epic.name }}">
        {{ render_epic_basic(epic) }}
        <p>
        Left to do: {{ "%.3g" % model.remaining_point_estimate_of(epic.name).expected }}, i.e. {{ "%i %%" % (model.remaining_point_estimate_of(epic.name).expected / model.remaining_point_estimate.expected * 100) }} of the whole
        </p>
        {% if recursive -%}
        <ul>
            {% for target in (epic.children | sort(attribute="name")) %}
            {{- render_whatever(target, model, recursive=recursive) -}}
            {% endfor %}
        </ul>
        {%- endif %}
        </div>
        </li>
{% endmacro %}

{% macro render_estimate(estimate, unit="") -%}
	{{ "{expected:.3g}{unit_with_space}, ùúé = {sigma:.2g}{unit_with_space}".format(
		expected=estimate.expected, sigma=estimate.sigma, unit_with_space=" " ~ unit) }}
{%- endmacro %}

{% macro render_precise_estimate(number, unit="") -%}
	{{ "{expected:.3g}{unit_with_space}".format(
		expected=number, unit_with_space=" " ~ unit) }}
{%- endmacro %}


{% macro accordion_with_stuff(stem, collapsed, header_text, body_text, heading_level=4) -%}
<div class="accordion" id="accordion{{ stem }}">
<div class="accordion-item">
	<h{{ heading_level }} class="accordion-header" id="accordionHeading">
		<button class="accordion-button {{- " collapsed" if collapsed }}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ stem }}" aria-expanded="{{ "false" if collapsed else "true" }}" aria-controls="collapse{{ stem }}">
			{{ header_text }}
		</button>
	</h{{ heading_level }}>
	<div id="collapse{{ stem }}" class="accordion-collapse collapse {{- " show" if not collapsed }}" aria-labelledby="accordionHeading" data-bs-parent="#accordion{{ stem }}">
		<div class="accordion-body">
			{{ body_text }}
		</div>
	</div>
</div>
</div>
{%- endmacro %}


{% macro task_metadata(task) -%}
<h2>{{ task.title }}</h2>
{% if task.uri -%}
<a href="{{ task.uri }}">{{ task.uri }}</a>
{% endif -%}
<div>State: {{ state_to_string(task.state)  }}</div>
{% if (task.description | length) < 1200 %}
<h3>Description</h3>
<p>
{{ (task.description | safe) or "No description" }}
</p>
{%- else %}
{{ accordion_with_stuff("Description", true, "Description", (task.description | safe) or "No description", 3) }}
{%- endif %}
{%- endmacro %}


{% macro render_similar_sized_tasks(similar_sized_targets) -%}
    <div class="row">
    <h4>Tasks of similar sizes</h4>
    <p>
    <ul>
    {%- for target in similar_sized_targets %}
    <li>{{ render_task_basic(target, None) }}: {{ render_estimate(target.point_estimate) }}</li>
    {%- endfor %}
    </ul>
    </p>
    </div>
{%- endmacro %}


{% set states_table = {
    State.todo: "To Do",
    State.in_progress: "In Progress",
    State.review: "Needs Peer Review",
    State.done: "Done",
    State.abandoned: "Abandoned",
} %}


{% macro state_to_string(state) -%}
    {{ states_table.get(state, "Unknown") }}
{%- endmacro %}


{% macro show_refresh_form(refresh_form) -%}
	{% if refresh_form %}
        <div class="col">
	{{ caller() }}
	{{ render_form(refresh_form, action=url_for("main.refresh")) }}
        </div>
	{% endif %}
{%- endmacro %}
